<!-- ARQUIVO C√ìPIA -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Atividades - Sistema de Evid√™ncias</title>
    
    <!-- Bibliotecas externas via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.1/dist/dexie.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --text-color: #333;
            --bg-color: #f8f9fa;
            --sidebar-width: 250px;
            --header-height: 60px;
            --container-padding: 16px;
        }

        .dark-mode {
            --text-color: #ecf0f1;
            --bg-color: #2c3e50;
            --light-color: #34495e;
            --dark-color: #ecf0f1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            background-color: var(--bg-color);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Layout principal */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            width: 100%;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px var(--container-padding);
            background-color: var(--light-color);
            border-bottom: 1px solid #ddd;
            position: sticky;
            top: 0;
            z-index: 100;
            height: var(--header-height);
        }

        .hamburger {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            padding: 8px;
        }

        .app-title {
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
            flex: 1;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-online {
            background-color: var(--success-color);
        }

        .status-offline {
            background-color: var(--danger-color);
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--secondary-color);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            top: 0;
            left: 0;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: var(--header-height);
        }

        .sidebar-menu {
            list-style: none;
            padding: 0.5rem 0;
        }

        .sidebar-menu li {
            padding: 0;
        }

        .sidebar-menu a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 1rem;
            border-radius: 0;
            transition: background-color 0.3s;
            font-size: 1rem;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar-menu i {
            margin-right: 0.5rem;
            width: 24px;
            text-align: center;
        }

        /* Overlay para fechar o menu */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* Conte√∫do principal */
        .main-content {
            flex: 1;
            padding: var(--container-padding);
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Se√ß√µes de conte√∫do */
        .content-section {
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        /* Formul√°rio */
        .form-container {
            width: 100%;
            margin: 0 auto;
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .form-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--secondary-color);
            padding: 0 8px;
        }

        .form-group {
            margin-bottom: 1rem;
            width: 100%;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            width: 100%;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            max-width: 100%;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 4px;
            width: auto;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #219a52;
        }

        /* C√¢mera e upload de fotos */
        .photo-section {
            margin-top: 1.5rem;
            width: 100%;
        }

        .camera-container {
            width: 100%;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
        }

        #videoElement {
            width: 100%;
            max-width: 100%;
            background-color: #ddd;
            border-radius: 4px;
            aspect-ratio: 4/3;
        }

        .photo-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 1rem;
            width: 100%;
            justify-content: center;
        }

        .photo-thumbnail {
            position: relative;
            width: 100px;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Dashboard */
        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 1.5rem;
            width: 100%;
        }

        .kpi-card {
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 0;
        }

        .kpi-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .kpi-label {
            font-size: 0.8rem;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chart-container {
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .chart-container canvas {
            max-width: 100%;
            height: auto !important;
        }

        /* Tabela de atividades */
        .activities-table-container {
            overflow-x: auto;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }

        .activities-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 600px;
        }

        .activities-table th, .activities-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.9rem;
        }

        .activities-table th {
            background-color: var(--light-color);
            font-weight: 600;
            white-space: nowrap;
        }

        .activities-table tr:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 1rem;
            border-radius: 8px;
            width: 100%;
            max-width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Filtros */
        .filters-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        .date-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .date-filters input {
            flex: 1;
            min-width: 120px;
        }

        /* Bot√µes em grupo */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 12px 0;
        }

        /* Responsividade */
        @media (min-width: 768px) {
            :root {
                --container-padding: 20px;
            }
            
            .app-container {
                flex-direction: row;
            }
            
            .sidebar {
                transform: translateX(0);
                position: relative;
                height: 100vh;
            }
            
            .main-content {
                margin-left: 0;
                flex: 1;
                overflow-y: auto;
            }
            
            .hamburger {
                display: none;
            }
            
            .overlay {
                display: none !important;
            }
            
            .app-title {
                font-size: 1.5rem;
                text-align: left;
                padding-left: 16px;
            }
            
            .kpi-cards {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .form-container {
                padding: 1.5rem;
            }
        }

        @media (max-width: 767px) {
            .main-content.sidebar-open {
                margin-left: 0;
                transform: translateX(var(--sidebar-width));
            }
            
            .sidebar {
                width: 80%;
                max-width: 300px;
            }
            
            .button-group {
                justify-content: center;
            }
            
            .button-group .btn {
                flex: 1;
                min-width: 120px;
            }
            
            .date-filters {
                flex-direction: column;
            }
        }

        /* Utilit√°rios */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-1 {
            margin-top: 0.5rem;
        }

        .mt-2 {
            margin-top: 1rem;
        }

        .mt-3 {
            margin-top: 1.5rem;
        }

        .mb-1 {
            margin-bottom: 0.5rem;
        }

        .mb-2 {
            margin-bottom: 1rem;
        }

        .mb-3 {
            margin-bottom: 1.5rem;
        }

        /* Dark mode */
        body.dark-mode {
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        body.dark-mode .form-container,
        body.dark-mode .kpi-card,
        body.dark-mode .chart-container,
        body.dark-mode .activities-table,
        body.dark-mode .modal-content {
            background-color: var(--light-color);
            color: var(--text-color);
        }

        body.dark-mode .form-input,
        body.dark-mode .form-select,
        body.dark-mode .form-textarea {
            background-color: #3a3f44;
            border-color: #4a4f54;
            color: var(--text-color);
        }

        body.dark-mode .activities-table th {
            background-color: #3a3f44;
            color: var(--text-color);
        }

        body.dark-mode .activities-table tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Menu</h2>
                <button class="hamburger" id="closeSidebar">‚úï</button>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="active" data-section="dashboard"><i>üìä</i> Dashboard</a></li>
                <li><a href="#" data-section="register"><i>‚ûï</i> Nova Atividade</a></li>
                <li><a href="#" data-section="activities"><i>üìã</i> Lista de Atividades</a></li>
                <li><a href="#" data-section="reports"><i>üìÑ</i> Relat√≥rios</a></li>
                <li><a href="#" data-section="backup"><i>üíæ</i> Backup/Restore</a></li>
                <li><a href="#" data-section="settings"><i>‚öôÔ∏è</i> Configura√ß√µes</a></li>
            </ul>
        </div>

        <!-- Overlay para fechar o menu em mobile -->
        <div class="overlay" id="overlay"></div>

        <!-- Conte√∫do principal -->
        <div class="main-content" id="mainContent">
            <!-- Header -->
            <div class="header">
                <button class="hamburger" id="openSidebar">‚ò∞</button>
                <div class="app-title">Registro de Atividades</div>
                <div class="status">
                    <span class="status-indicator status-online" id="statusIndicator"></span>
                    <span id="statusText">Online</span>
                </div>
            </div>

            <!-- Se√ß√µes de conte√∫do -->
            <div id="contentSections">
                <!-- Dashboard -->
                <section id="dashboardSection" class="content-section">
                    <h1 class="form-title">Dashboard</h1>
                    
                    <div class="kpi-cards">
                        <div class="kpi-card">
                            <div class="kpi-value" id="totalProduced">0</div>
                            <div class="kpi-label">Total Produzido</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="totalLosses">0</div>
                            <div class="kpi-label">Total de Perdas</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="efficiency">0%</div>
                            <div class="kpi-label">Efici√™ncia</div>
                        </div>
                        <div class="kpi-card">
                            <div class="kpi-value" id="activitiesCount">0</div>
                            <div class="kpi-label">Atividades Hoje</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="productionChart"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="efficiencyChart"></canvas>
                    </div>
                </section>

                <!-- Formul√°rio de registro -->
                <section id="registerSection" class="content-section hidden">
                    <h1 class="form-title">Nova Atividade</h1>
                    
                    <div class="form-container">
                        <form id="activityForm">
                            <div class="form-group">
                                <label class="form-label" for="description">Descri√ß√£o da Atividade *</label>
                                <textarea class="form-textarea" id="description" name="description" required></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="category">Categoria</label>
                                <select class="form-select" id="category" name="category">
                                    <option value="">Selecione...</option>
                                    <option value="Producao">Produ√ß√£o</option>
                                    <option value="Limpeza">Limpeza</option>
                                    <option value="Setup">Setup</option>
                                    <option value="Manutencao">Manuten√ß√£o</option>
                                    <option value="Outro">Outro</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="produced">Quantidade Produzida *</label>
                                <input type="number" class="form-input" id="produced" name="produced" min="0" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="losses">Quantidade de Perdas</label>
                                <input type="number" class="form-input" id="losses" name="losses" min="0" value="0">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="unit">Unidade de Medida</label>
                                <select class="form-select" id="unit" name="unit">
                                    <option value="un">Unidade (un)</option>
                                    <option value="kg">Quilograma (kg)</option>
                                    <option value="l">Litro (l)</option>
                                    <option value="lote">Lote</option>
                                    <option value="caixa">Caixa</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="shift">Turno</label>
                                <select class="form-select" id="shift" name="shift">
                                    <option value="">Selecione...</option>
                                    <option value="Manha">Manh√£</option>
                                    <option value="Tarde">Tarde</option>
                                    <option value="Noite">Noite</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="collaborators">Colaboradores Envolvidos</label>
                                <input type="text" class="form-input" id="collaborators" name="collaborators" placeholder="Nomes separados por v√≠rgula">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="tags">Tags</label>
                                <input type="text" class="form-input" id="tags" name="tags" placeholder="Tags separadas por v√≠rgula">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="notes">Observa√ß√µes</label>
                                <textarea class="form-textarea" id="notes" name="notes"></textarea>
                            </div>
                            
                            <div class="photo-section">
                                <h3 class="form-label">Fotos de Evid√™ncia</h3>
                                
                                <div class="camera-container hidden" id="cameraContainer">
                                    <video id="videoElement" autoplay playsinline></video>
                                    <button type="button" class="btn btn-primary mt-1" id="captureButton">Capturar Foto</button>
                                </div>
                                
                                <div class="button-group">
                                    <button type="button" class="btn btn-primary" id="toggleCamera">Abrir C√¢mera</button>
                                    <button type="button" class="btn btn-primary" id="uploadPhoto">Upload de Foto</button>
                                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                                </div>
                                
                                <div class="photo-preview mt-2" id="photoPreview"></div>
                            </div>
                            
                            <div class="button-group mt-3">
                                <button type="submit" class="btn btn-primary">Salvar Atividade</button>
                                <button type="button" class="btn btn-success" id="duplicateButton" disabled>Duplicar (Ctrl+D)</button>
                                <button type="reset" class="btn btn-danger">Limpar</button>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- Lista de atividades -->
                <section id="activitiesSection" class="content-section hidden">
                    <h1 class="form-title">Lista de Atividades</h1>
                    
                    <div class="form-container">
                        <div class="form-group">
                            <input type="text" class="form-input" id="searchActivities" placeholder="Buscar atividades...">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="dateFilter">Filtrar por data:</label>
                            <div class="filters-container">
                                <div class="date-filters">
                                    <input type="date" class="form-input" id="startDate">
                                    <input type="date" class="form-input" id="endDate">
                                </div>
                                <div class="button-group">
                                    <button class="btn btn-primary" id="applyFilter">Aplicar</button>
                                    <button class="btn btn-danger" id="clearFilter">Limpar</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="activities-table-container">
                            <table class="activities-table">
                                <thead>
                                    <tr>
                                        <th>Data/Hora</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Categoria</th>
                                        <th>Produzido</th>
                                        <th>Perdas</th>
                                        <th>Efici√™ncia</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="activitiesTableBody">
                                    <!-- Os dados ser√£o preenchidos via JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-2 text-center">
                            <button class="btn btn-primary" id="loadMoreActivities">Carregar Mais</button>
                        </div>
                    </div>
                </section>

                <!-- Relat√≥rios -->
                <section id="reportsSection" class="content-section hidden">
                    <h1 class="form-title">Relat√≥rios</h1>
                    
                    <div class="form-container">
                        <div class="form-group">
                            <label class="form-label" for="reportRange">Per√≠odo do Relat√≥rio:</label>
                            <div class="date-filters">
                                <input type="date" class="form-input" id="reportStartDate">
                                <input type="date" class="form-input" id="reportEndDate">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="reportType">Tipo de Relat√≥rio:</label>
                            <select class="form-select" id="reportType">
                                <option value="pdf">PDF Detalhado</option>
                                <option value="csv">CSV Simples</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-primary" id="generateReport">Gerar Relat√≥rio</button>
                        </div>
                    </div>
                </section>

                <!-- Backup/Restore -->
                <section id="backupSection" class="content-section hidden">
                    <h1 class="form-title">Backup e Restaura√ß√£o</h1>
                    
                    <div class="form-container">
                        <div class="form-group">
                            <h3 class="form-label">Criar Backup</h3>
                            <p>O backup inclui todas as atividades, fotos e hist√≥rico de edi√ß√µes.</p>
                            <button class="btn btn-primary" id="createBackup">Criar Backup (ZIP)</button>
                        </div>
                        
                        <div class="form-group mt-3">
                            <h3 class="form-label">Restaurar Backup</h3>
                            <p>Selecione um arquivo ZIP de backup para restaurar:</p>
                            <input type="file" class="form-input" id="restoreFile" accept=".zip">
                            <button class="btn btn-success mt-1" id="restoreBackup" disabled>Restaurar Backup</button>
                        </div>
                        
                        <div class="form-group mt-3">
                            <h3 class="form-label">Exportar/Importar Dados</h3>
                            <p>Para interoperabilidade com outros sistemas:</p>
                            <div class="button-group">
                                <button class="btn btn-primary" id="exportJSON">Exportar JSON</button>
                                <button class="btn btn-primary" id="importJSON">Importar JSON</button>
                                <input type="file" class="hidden" id="importFile" accept=".json">
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Configura√ß√µes -->
                <section id="settingsSection" class="content-section hidden">
                    <h1 class="form-title">Configura√ß√µes</h1>
                    
                    <div class="form-container">
                        <div class="form-group">
                            <label class="form-label" for="userName">Seu Nome</label>
                            <input type="text" class="form-input" id="userName" placeholder="Seu nome para os registros">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="pinCode">PIN de Seguran√ßa</label>
                            <input type="password" class="form-input" id="pinCode" placeholder="Defina um PIN de 4 d√≠gitos" maxlength="4">
                            <p class="form-text">O PIN √© armazenado localmente e usado para proteger o acesso ao sistema.</p>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="darkModeToggle"> Modo Escuro
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="autoBackupToggle"> Backup Autom√°tico Di√°rio
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <button class="btn btn-primary" id="saveSettings">Salvar Configura√ß√µes</button>
                        </div>
                        
                        <div class="form-group mt-3">
                            <h3 class="form-label">Sistema</h3>
                            <p>Espa√ßo utilizado: <span id="storageUsage">0 MB</span></p>
                            <p>Vers√£o: 1.0.0</p>
                            <button class="btn btn-danger" id="clearData">Limpar Todos os Dados</button>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Modal para visualiza√ß√£o de atividade -->
    <div class="modal" id="activityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes da Atividade</h2>
                <button class="modal-close" id="closeModal">√ó</button>
            </div>
            <div id="modalBody">
                <!-- Conte√∫do ser√° preenchido via JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o inicial do banco de dados com Dexie
        const db = new Dexie('WorkActivityTracker');
        db.version(1).stores({
            activities: '++id, timestamp, description, category, produced, losses, unit, shift, collaborators, tags, notes, efficiency',
            photos: '++id, activityId, timestamp, imageData, hash, exifData',
            edits: '++id, activityId, timestamp, user, reason, changes',
            settings: 'key, value'
        });

        // Estado da aplica√ß√£o
        let appState = {
            currentActivityId: null,
            currentPhotos: [],
            stream: null,
            activities: [],
            currentPage: 1,
            pageSize: 10,
            settings: {
                userName: 'Usu√°rio',
                pinCode: null,
                darkMode: false,
                autoBackup: false
            }
        };

        // Inicializa√ß√£o da aplica√ß√£o
        document.addEventListener('DOMContentLoaded', async function() {
            await initDatabase();
            await loadSettings();
            setupEventListeners();
            updateUI();
            checkOnlineStatus();
            
            // Mostrar dashboard por padr√£o
            showSection('dashboard');
            
            // Carregar atividades iniciais
            await loadActivities();
            updateDashboard();
        });

        // Inicializar o banco de dados
        async function initDatabase() {
            try {
                await db.open();
                console.log('Banco de dados aberto com sucesso');
            } catch (error) {
                console.error('Falha ao abrir o banco de dados:', error);
            }
        }

        // Carregar configura√ß√µes
        async function loadSettings() {
            try {
                const settings = await db.settings.toArray();
                settings.forEach(setting => {
                    if (setting.key in appState.settings) {
                        appState.settings[setting.key] = setting.value;
                    }
                });
                
                // Aplicar modo escuro se estiver ativado
                if (appState.settings.darkMode) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('darkModeToggle').checked = true;
                }
                
                // Preencher campos de configura√ß√£o
                if (appState.settings.userName) {
                    document.getElementById('userName').value = appState.settings.userName;
                }
                
                if (appState.settings.pinCode) {
                    document.getElementById('pinCode').value = appState.settings.pinCode;
                }
                
                document.getElementById('autoBackupToggle').checked = appState.settings.autoBackup;
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes:', error);
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Menu lateral
            document.getElementById('openSidebar').addEventListener('click', openSidebar);
            document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
            document.getElementById('overlay').addEventListener('click', closeSidebar);
            
            // Navega√ß√£o do menu
            const menuItems = document.querySelectorAll('.sidebar-menu a');
            menuItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    closeSidebar();
                    
                    // Atualizar classe ativa
                    menuItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Formul√°rio de atividade
            document.getElementById('activityForm').addEventListener('submit', saveActivity);
            document.getElementById('toggleCamera').addEventListener('click', toggleCamera);
            document.getElementById('captureButton').addEventListener('click', capturePhoto);
            document.getElementById('uploadPhoto').addEventListener('click', triggerUpload);
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('duplicateButton').addEventListener('click', duplicateActivity);
            
            // Atalhos de teclado
            document.addEventListener('keydown', handleKeyboardShortcuts);
            
            // Lista de atividades
            document.getElementById('searchActivities').addEventListener('input', filterActivities);
            document.getElementById('applyFilter').addEventListener('click', filterActivities);
            document.getElementById('clearFilter').addEventListener('click', clearFilter);
            document.getElementById('loadMoreActivities').addEventListener('click', loadMoreActivities);
            
            // Relat√≥rios
            document.getElementById('generateReport').addEventListener('click', generateReport);
            
            // Backup/Restore
            document.getElementById('createBackup').addEventListener('click', createBackup);
            document.getElementById('restoreFile').addEventListener('change', function() {
                document.getElementById('restoreBackup').disabled = !this.files.length;
            });
            document.getElementById('restoreBackup').addEventListener('click', restoreBackup);
            document.getElementById('exportJSON').addEventListener('click', exportJSON);
            document.getElementById('importJSON').addEventListener('click', triggerJSONImport);
            document.getElementById('importFile').addEventListener('change', importJSON);
            
            // Configura√ß√µes
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            document.getElementById('darkModeToggle').addEventListener('change', toggleDarkMode);
            document.getElementById('clearData').addEventListener('click', clearAllData);
            
            // Modal
            document.getElementById('closeModal').addEventListener('click', closeModal);
            
            // Verificar status online/offline
            window.addEventListener('online', () => updateOnlineStatus(true));
            window.addEventListener('offline', () => updateOnlineStatus(false));
        }

        // Atualizar a interface
        function updateUI() {
            // Atualizar data/hora atual no formul√°rio
            const now = new Date();
            document.getElementById('produced').focus();
            
            // Atualizar contador de atividades do dia
            updateTodaysActivityCount();
        }

        // Mostrar se√ß√£o espec√≠fica
        function showSection(sectionId) {
            // Esconder todas as se√ß√µes
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.classList.add('hidden'));
            
            // Mostrar a se√ß√£o solicitada
            document.getElementById(sectionId + 'Section').classList.remove('hidden');
            
            // A√ß√µes espec√≠ficas por se√ß√£o
            if (sectionId === 'dashboard') {
                updateDashboard();
            } else if (sectionId === 'activities') {
                loadActivities();
            }
        }

        // Abrir/fechar menu lateral
        function openSidebar() {
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('overlay').classList.add('active');
            document.getElementById('mainContent').classList.add('sidebar-open');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('mainContent').classList.remove('sidebar-open');
        }

        // Verificar status online/offline
        function checkOnlineStatus() {
            updateOnlineStatus(navigator.onLine);
        }

        function updateOnlineStatus(online) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            
            if (online) {
                indicator.classList.remove('status-offline');
                indicator.classList.add('status-online');
                text.textContent = 'Online';
            } else {
                indicator.classList.remove('status-online');
                indicator.classList.add('status-offline');
                text.textContent = 'Offline';
            }
        }

        // Alternar c√¢mera
        async function toggleCamera() {
            const cameraContainer = document.getElementById('cameraContainer');
            const toggleButton = document.getElementById('toggleCamera');
            
            if (cameraContainer.classList.contains('hidden')) {
                try {
                    appState.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' }, 
                        audio: false 
                    });
                    document.getElementById('videoElement').srcObject = appState.stream;
                    cameraContainer.classList.remove('hidden');
                    toggleButton.textContent = 'Fechar C√¢mera';
                } catch (error) {
                    console.error('Erro ao acessar a c√¢mera:', error);
                    alert('N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes.');
                }
            } else {
                if (appState.stream) {
                    appState.stream.getTracks().forEach(track => track.stop());
                    appState.stream = null;
                }
                cameraContainer.classList.add('hidden');
                toggleButton.textContent = 'Abrir C√¢mera';
            }
        }

        // Capturar foto
        function capturePhoto() {
            const video = document.getElementById('videoElement');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg');
            addPhotoToPreview(imageData);
        }

        // Disparar upload de arquivo
        function triggerUpload() {
            document.getElementById('fileInput').click();
        }

        // Manipular upload de arquivo
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                addPhotoToPreview(e.target.result);
            };
            reader.readAsDataURL(file);
            
            // Limpar o input para permitir upload do mesmo arquivo novamente
            event.target.value = '';
        }

        // Adicionar foto √† visualiza√ß√£o
        function addPhotoToPreview(imageData) {
            appState.currentPhotos.push(imageData);
            
            const previewContainer = document.getElementById('photoPreview');
            const thumbnail = document.createElement('div');
            thumbnail.className = 'photo-thumbnail';
            
            const img = document.createElement('img');
            img.src = imageData;
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-photo';
            removeBtn.innerHTML = '√ó';
            removeBtn.addEventListener('click', function() {
                const index = appState.currentPhotos.indexOf(imageData);
                if (index > -1) {
                    appState.currentPhotos.splice(index, 1);
                }
                thumbnail.remove();
            });
            
            thumbnail.appendChild(img);
            thumbnail.appendChild(removeBtn);
            previewContainer.appendChild(thumbnail);
        }

        // Salvar atividade
        async function saveActivity(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const produced = parseInt(formData.get('produced')) || 0;
            const losses = parseInt(formData.get('losses')) || 0;
            const total = produced + losses;
            const efficiency = total > 0 ? (produced / total * 100).toFixed(2) : 0;
            
            const activity = {
                timestamp: new Date(),
                description: formData.get('description'),
                category: formData.get('category'),
                produced: produced,
                losses: losses,
                unit: formData.get('unit'),
                shift: formData.get('shift'),
                collaborators: formData.get('collaborators'),
                tags: formData.get('tags'),
                notes: formData.get('notes'),
                efficiency: efficiency
            };
            
            try {
                // Salvar atividade no banco de dados
                const id = await db.activities.add(activity);
                
                // Salvar fotos associadas
                for (const photoData of appState.currentPhotos) {
                    // Calcular hash da imagem
                    const hash = await calculateHash(photoData);
                    
                    await db.photos.add({
                        activityId: id,
                        timestamp: new Date(),
                        imageData: photoData,
                        hash: hash,
                        exifData: {} // Extrair EXIF seria implementado aqui
                    });
                }
                
                // Limpar formul√°rio e fotos
                event.target.reset();
                appState.currentPhotos = [];
                document.getElementById('photoPreview').innerHTML = '';
                
                alert('Atividade salva com sucesso!');
                
                // Atualizar dashboard e lista
                await loadActivities();
                updateDashboard();
                updateTodaysActivityCount();
                
            } catch (error) {
                console.error('Erro ao salvar atividade:', error);
                alert('Erro ao salvar atividade. Tente novamente.');
            }
        }

        // Calcular hash SHA-256
        async function calculateHash(data) {
            // Usando CryptoJS para calcular o hash
            return CryptoJS.SHA256(data).toString();
        }

        // Duplicar atividade
        function duplicateActivity() {
            // Implementa√ß√£o simplificada - preencher formul√°rio com dados da √∫ltima atividade
            alert('Funcionalidade de duplica√ß√£o ser√° implementada aqui.');
        }

        // Manipular atalhos de teclado
        function handleKeyboardShortcuts(event) {
            // Ctrl+S para salvar
            if (event.ctrlKey && event.key === 's') {
                event.preventDefault();
                document.getElementById('activityForm').dispatchEvent(new Event('submit'));
            }
            
            // Ctrl+D para duplicar
            if (event.ctrlKey && event.key === 'd') {
                event.preventDefault();
                duplicateActivity();
            }
            
            // Ctrl+Shift+F para nova foto
            if (event.ctrlKey && event.shiftKey && event.key === 'F') {
                event.preventDefault();
                triggerUpload();
            }
        }

        // Carregar atividades
        async function loadActivities() {
            try {
                // Carregar atividades do banco de dados
                const activities = await db.activities
                    .reverse()
                    .offset((appState.currentPage - 1) * appState.pageSize)
                    .limit(appState.pageSize)
                    .toArray();
                
                appState.activities = activities;
                renderActivitiesTable();
            } catch (error) {
                console.error('Erro ao carregar atividades:', error);
            }
        }

        // Renderizar tabela de atividades
        function renderActivitiesTable() {
            const tbody = document.getElementById('activitiesTableBody');
            tbody.innerHTML = '';
            
            if (appState.activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Nenhuma atividade encontrada.</td></tr>';
                return;
            }
            
            appState.activities.forEach(activity => {
                const row = document.createElement('tr');
                
                const date = new Date(activity.timestamp).toLocaleString();
                
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${activity.description}</td>
                    <td>${activity.category || '-'}</td>
                    <td>${activity.produced} ${activity.unit}</td>
                    <td>${activity.losses} ${activity.unit}</td>
                    <td>${activity.efficiency}%</td>
                    <td>
                        <button class="btn btn-primary view-activity" data-id="${activity.id}">Ver</button>
                        <button class="btn btn-success edit-activity" data-id="${activity.id}">Editar</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Adicionar event listeners aos bot√µes
            document.querySelectorAll('.view-activity').forEach(btn => {
                btn.addEventListener('click', function() {
                    viewActivity(parseInt(this.getAttribute('data-id')));
                });
            });
            
            document.querySelectorAll('.edit-activity').forEach(btn => {
                btn.addEventListener('click', function() {
                    editActivity(parseInt(this.getAttribute('data-id')));
                });
            });
        }

        // Ver atividade
        async function viewActivity(id) {
            try {
                const activity = await db.activities.get(id);
                const photos = await db.photos.where('activityId').equals(id).toArray();
                
                let modalContent = `
                    <h3>${activity.description}</h3>
                    <p><strong>Data/Hora:</strong> ${new Date(activity.timestamp).toLocaleString()}</p>
                    <p><strong>Categoria:</strong> ${activity.category || 'N√£o informada'}</p>
                    <p><strong>Produzido:</strong> ${activity.produced} ${activity.unit}</p>
                    <p><strong>Perdas:</strong> ${activity.losses} ${activity.unit}</p>
                    <p><strong>Efici√™ncia:</strong> ${activity.efficiency}%</p>
                    <p><strong>Turno:</strong> ${activity.shift || 'N√£o informado'}</p>
                    <p><strong>Colaboradores:</strong> ${activity.collaborators || 'N√£o informados'}</p>
                    <p><strong>Tags:</strong> ${activity.tags || 'Nenhuma'}</p>
                    <p><strong>Observa√ß√µes:</strong> ${activity.notes || 'Nenhuma'}</p>
                `;
                
                if (photos.length > 0) {
                    modalContent += `<h4>Fotos (${photos.length})</h4><div class="photo-preview">`;
                    photos.forEach(photo => {
                        modalContent += `
                            <div class="photo-thumbnail">
                                <img src="${photo.imageData}" alt="Foto da atividade">
                                <p><small>Hash: ${photo.hash.substring(0, 16)}...</small></p>
                            </div>
                        `;
                    });
                    modalContent += '</div>';
                }
                
                document.getElementById('modalBody').innerHTML = modalContent;
                document.getElementById('activityModal').classList.add('active');
                
            } catch (error) {
                console.error('Erro ao carregar atividade:', error);
                alert('Erro ao carregar atividade.');
            }
        }

        // Editar atividade
        async function editActivity(id) {
            // Implementa√ß√£o simplificada - em um sistema real, isso criaria uma nova vers√£o
            // com registro de altera√ß√µes conforme especificado
            alert(`Edi√ß√£o da atividade ${id} - Esta a√ß√£o criar√° um novo registro de vers√£o.`);
        }

        // Fechar modal
        function closeModal() {
            document.getElementById('activityModal').classList.remove('active');
        }

        // Filtrar atividades
        async function filterActivities() {
            // Implementa√ß√£o simplificada - filtrar atividades por termo de busca e data
            const searchTerm = document.getElementById('searchActivities').value.toLowerCase();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            let filteredActivities = await db.activities.toArray();
            
            if (searchTerm) {
                filteredActivities = filteredActivities.filter(a => 
                    a.description.toLowerCase().includes(searchTerm) ||
                    (a.tags && a.tags.toLowerCase().includes(searchTerm)) ||
                    (a.notes && a.notes.toLowerCase().includes(searchTerm))
                );
            }
            
            if (startDate) {
                const start = new Date(startDate);
                filteredActivities = filteredActivities.filter(a => new Date(a.timestamp) >= start);
            }
            
            if (endDate) {
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                filteredActivities = filteredActivities.filter(a => new Date(a.timestamp) <= end);
            }
            
            appState.activities = filteredActivities;
            renderActivitiesTable();
        }

        // Limpar filtros
        function clearFilter() {
            document.getElementById('searchActivities').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            loadActivities();
        }

        // Carregar mais atividades
        function loadMoreActivities() {
            appState.currentPage++;
            loadActivities();
        }

        // Atualizar dashboard
        async function updateDashboard() {
            try {
                const activities = await db.activities.toArray();
                
                // Calcular totais
                const totalProduced = activities.reduce((sum, a) => sum + a.produced, 0);
                const totalLosses = activities.reduce((sum, a) => sum + a.losses, 0);
                const totalActivities = activities.length;
                
                const total = totalProduced + totalLosses;
                const overallEfficiency = total > 0 ? (totalProduced / total * 100).toFixed(2) : 0;
                
                // Atualizar KPIs
                document.getElementById('totalProduced').textContent = totalProduced;
                document.getElementById('totalLosses').textContent = totalLosses;
                document.getElementById('efficiency').textContent = `${overallEfficiency}%`;
                document.getElementById('activitiesCount').textContent = totalActivities;
                
                // Atualizar gr√°ficos (implementa√ß√£o simplificada)
                updateCharts(activities);
                
            } catch (error) {
                console.error('Erro ao atualizar dashboard:', error);
            }
        }

        // Atualizar gr√°ficos
        function updateCharts(activities) {
            // Agrupar atividades por data (implementa√ß√£o simplificada)
            const dailyData = {};
            
            activities.forEach(activity => {
                const date = new Date(activity.timestamp).toLocaleDateString();
                if (!dailyData[date]) {
                    dailyData[date] = { produced: 0, losses: 0, count: 0 };
                }
                
                dailyData[date].produced += activity.produced;
                dailyData[date].losses += activity.losses;
                dailyData[date].count++;
            });
            
            const dates = Object.keys(dailyData);
            const producedData = dates.map(date => dailyData[date].produced);
            const lossesData = dates.map(date => dailyData[date].losses);
            const efficiencyData = dates.map(date => {
                const total = dailyData[date].produced + dailyData[date].losses;
                return total > 0 ? (dailyData[date].produced / total * 100) : 0;
            });
            
            // Gr√°fico de produ√ß√£o e perdas
            const productionCtx = document.getElementById('productionChart').getContext('2d');
            if (window.productionChart) {
                window.productionChart.destroy();
            }
            window.productionChart = new Chart(productionCtx, {
                type: 'bar',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Produzido',
                            data: producedData,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)'
                        },
                        {
                            label: 'Perdas',
                            data: lossesData,
                            backgroundColor: 'rgba(231, 76, 60, 0.7)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Gr√°fico de efici√™ncia
            const efficiencyCtx = document.getElementById('efficiencyChart').getContext('2d');
            if (window.efficiencyChart) {
                window.efficiencyChart.destroy();
            }
            window.efficiencyChart = new Chart(efficiencyCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Efici√™ncia (%)',
                            data: efficiencyData,
                            borderColor: 'rgba(46, 204, 113, 1)',
                            backgroundColor: 'rgba(46, 204, 113, 0.2)',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Atualizar contador de atividades do dia
        async function updateTodaysActivityCount() {
            try {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                
                const count = await db.activities
                    .where('timestamp')
                    .between(today, tomorrow)
                    .count();
                
                // Poderia exibir este count em algum lugar da UI
                console.log(`Atividades hoje: ${count}`);
            } catch (error) {
                console.error('Erro ao contar atividades do dia:', error);
            }
        }

        // Gerar relat√≥rio
        async function generateReport() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const reportType = document.getElementById('reportType').value;
            
            if (!startDate || !endDate) {
                alert('Selecione um per√≠odo para o relat√≥rio.');
                return;
            }
            
            try {
                const start = new Date(startDate);
                const end = new Date(endDate);
                end.setHours(23, 59, 59, 999);
                
                const activities = await db.activities
                    .where('timestamp')
                    .between(start, end)
                    .toArray();
                
                if (activities.length === 0) {
                    alert('Nenhuma atividade encontrada no per√≠odo selecionado.');
                    return;
                }
                
                if (reportType === 'pdf') {
                    generatePDFReport(activities, start, end);
                } else {
                    exportCSV(activities);
                }
                
            } catch (error) {
                console.error('Erro ao gerar relat√≥rio:', error);
                alert('Erro ao gerar relat√≥rio.');
            }
        }

        // Gerar relat√≥rio PDF
        function generatePDFReport(activities, startDate, endDate) {
            alert('Gerando relat√≥rio PDF...');
            // Implementa√ß√£o real usaria html2pdf ou jsPDF
            // Esta √© uma implementa√ß√£o simplificada
        }

        // Exportar CSV
        function exportCSV(activities) {
            let csv = 'Data,Hora,Descri√ß√£o,Categoria,Produzido,Perdas,Unidade,Efici√™ncia\n';
            
            activities.forEach(activity => {
                const date = new Date(activity.timestamp);
                const dateStr = date.toLocaleDateString();
                const timeStr = date.toLocaleTimeString();
                
                csv += `"${dateStr}","${timeStr}","${activity.description}","${activity.category || ''}",${activity.produced},${activity.losses},"${activity.unit}",${activity.efficiency}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `atividades_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Criar backup
        async function createBackup() {
            try {
                alert('Criando backup...');
                
                // Coletar todos os dados
                const activities = await db.activities.toArray();
                const photos = await db.photos.toArray();
                const edits = await db.edits.toArray();
                const settings = await db.settings.toArray();
                
                // Criar objeto de backup
                const backupData = {
                    version: 1,
                    timestamp: new Date().toISOString(),
                    activities: activities,
                    photos: photos,
                    edits: edits,
                    settings: settings
                };
                
                // Converter para JSON
                const jsonData = JSON.stringify(backupData);
                
                // Criar ZIP (usando JSZip)
                const zip = new JSZip();
                zip.file('backup.json', jsonData);
                
                // Adicionar fotos (em um sistema real, separaria as imagens)
                // Esta √© uma implementa√ß√£o simplificada
                
                // Gerar ZIP
                const zipContent = await zip.generateAsync({ type: 'blob' });
                
                // Fazer download
                const link = document.createElement('a');
                const url = URL.createObjectURL(zipContent);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `backup_atividades_${new Date().toISOString().slice(0, 10)}.zip`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert('Backup criado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao criar backup:', error);
                alert('Erro ao criar backup.');
            }
        }

        // Restaurar backup
        async function restoreBackup() {
            const fileInput = document.getElementById('restoreFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Selecione um arquivo de backup.');
                return;
            }
            
            if (!confirm('ATEN√á√ÉO: Esta a√ß√£o substituir√° todos os dados atuais. Continuar?')) {
                return;
            }
            
            try {
                alert('Restaurando backup...');
                
                // Ler arquivo ZIP
                const zip = new JSZip();
                const zipContent = await zip.loadAsync(file);
                
                // Extrair backup.json
                const backupJson = await zipContent.file('backup.json').async('text');
                const backupData = JSON.parse(backupJson);
                
                // Verificar vers√£o
                if (backupData.version !== 1) {
                    throw new Error('Vers√£o de backup n√£o suportada.');
                }
                
                // Limpar banco de dados atual
                await db.activities.clear();
                await db.photos.clear();
                await db.edits.clear();
                await db.settings.clear();
                
                // Restaurar dados
                await db.activities.bulkAdd(backupData.activities);
                await db.photos.bulkAdd(backupData.photos);
                await db.edits.bulkAdd(backupData.edits);
                await db.settings.bulkAdd(backupData.settings);
                
                alert('Backup restaurado com sucesso!');
                
                // Recarregar dados
                await loadActivities();
                await loadSettings();
                updateDashboard();
                
            } catch (error) {
                console.error('Erro ao restaurar backup:', error);
                alert('Erro ao restaurar backup. O arquivo pode estar corrompido.');
            }
        }

        // Exportar JSON
        async function exportJSON() {
            try {
                const activities = await db.activities.toArray();
                const jsonData = JSON.stringify(activities, null, 2);
                
                const blob = new Blob([jsonData], { type: 'application/json' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `atividades_${new Date().toISOString().slice(0, 10)}.json`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
            } catch (error) {
                console.error('Erro ao exportar JSON:', error);
                alert('Erro ao exportar dados.');
            }
        }

        // Disparar importa√ß√£o de JSON
        function triggerJSONImport() {
            document.getElementById('importFile').click();
        }

        // Importar JSON
        async function importJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('Importar atividades deste arquivo?')) {
                return;
            }
            
            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const activities = JSON.parse(e.target.result);
                        
                        if (!Array.isArray(activities)) {
                            throw new Error('Formato de arquivo inv√°lido.');
                        }
                        
                        // Adicionar atividades ao banco de dados
                        await db.activities.bulkAdd(activities);
                        
                        alert(`${activities.length} atividades importadas com sucesso!`);
                        
                        // Recarregar dados
                        await loadActivities();
                        updateDashboard();
                        
                    } catch (error) {
                        console.error('Erro ao importar JSON:', error);
                        alert('Erro ao importar dados. Verifique o formato do arquivo.');
                    }
                };
                reader.readAsText(file);
                
            } catch (error) {
                console.error('Erro ao importar JSON:', error);
                alert('Erro ao importar dados.');
            }
        }

        // Salvar configura√ß√µes
        async function saveSettings() {
            try {
                const userName = document.getElementById('userName').value;
                const pinCode = document.getElementById('pinCode').value;
                const darkMode = document.getElementById('darkModeToggle').checked;
                const autoBackup = document.getElementById('autoBackupToggle').checked;
                
                // Validar PIN
                if (pinCode && !/^\d{4}$/.test(pinCode)) {
                    alert('O PIN deve conter exatamente 4 d√≠gitos.');
                    return;
                }
                
                // Salvar configura√ß√µes
                await db.settings.put({ key: 'userName', value: userName });
                await db.settings.put({ key: 'pinCode', value: pinCode });
                await db.settings.put({ key: 'darkMode', value: darkMode });
                await db.settings.put({ key: 'autoBackup', value: autoBackup });
                
                // Atualizar estado da aplica√ß√£o
                appState.settings.userName = userName;
                appState.settings.pinCode = pinCode;
                appState.settings.darkMode = darkMode;
                appState.settings.autoBackup = autoBackup;
                
                alert('Configura√ß√µes salvas com sucesso!');
                
            } catch (error) {
                console.error('Erro ao salvar configura√ß√µes:', error);
                alert('Erro ao salvar configura√ß√µes.');
            }
        }

        // Alternar modo escuro
        function toggleDarkMode() {
            const darkMode = document.getElementById('darkModeToggle').checked;
            
            if (darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            // Salvar configura√ß√£o
            db.settings.put({ key: 'darkMode', value: darkMode });
            appState.settings.darkMode = darkMode;
        }

        // Limpar todos os dados
        async function clearAllData() {
            if (!confirm('ATEN√á√ÉO: Esta a√ß√£o apagar√° TODOS os dados. N√£o √© poss√≠vel desfazer. Continuar?')) {
                return;
            }
            
            try {
                await db.activities.clear();
                await db.photos.clear();
                await db.edits.clear();
                
                alert('Todos os dados foram apagados.');
                
                // Recarregar
                await loadActivities();
                updateDashboard();
                
            } catch (error) {
                console.error('Erro ao apagar dados:', error);
                alert('Erro ao apagar dados.');
            }
        }
    </script>
</body>
</html>